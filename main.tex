% This file should be compiled with XeLaTeX.

\documentclass[]{memoir}

% Bibliography
\usepackage[style=apa]{biblatex}
\addbibresource{bibliography.bib}
\DefineBibliographyStrings{english}{%
  sequens = {f\adddot},
  sequentes = {ff\adddot},
}

\newbibmacro*{textciteshorttitle}{% Cite short titles. From Stack Exchange: https://tex.stackexchange.com/questions/489928/biblatex-apa-textcite-with-shorttitle
  \ifbool{cbx:parens}
    {\bibcloseparen\global\boolfalse{cbx:parens}}
    {}%
  \setunit{\compcitedelim}%
  \printfield[bibhyperref]{shorttitle}%
  \iffieldundef{postnote}
    {}
    {\ifnumequal{\value{citecount}}{\value{citetotal}}
       {\printunit{\global\booltrue{cbx:parens}\addspace\bibopenparen}}
       {}}}

\DeclareCiteCommand{\textciteshorttitle}
  {\usebibmacro{cite:init}%
   \usebibmacro{prenote}}
  {\usebibmacro{citeindex}%
   \usebibmacro{textciteshorttitle}}
  {}
  {\usebibmacro{textcite:postnote}%
   \usebibmacro{cite:post}}

% Font and typesetting
\usepackage[final]{microtype}

\usepackage{fontspec}
\setmainfont{Junicode}[
	Extension=.ttf,
	BoldFont=*-Bold,
	ItalicFont=*-Italic,
	BoldItalicFont=*-BoldItalic]

% TODO: Underline that does not skip descender?
% Should be called \nsunderline

% Packages
\usepackage{xparse}% For better document commands
\usepackage{graphicx}% For rotating characters (used when citing runic inscriptions)
\usepackage{hyperref}% For index links
\usepackage{geometry}% For margins.
\geometry{b5paper}% Book size
\usepackage{longtable}% Long tables.
\usepackage{tipa}% IPA

% Critical edition
\usepackage{reledmac}

% Headers
\usepackage{fancyhdr}
\pagestyle{fancy}
\fancyhead{}% Clear header
\fancyfoot{}% Clear footer
\fancyhead[OR,EL]{\thepage}% Page numbering on both odd and even
\fancyhead[EC]{The Anglish Edda}% Title of project (TODO: probably going to change!)
\fancyhead[OC]{\booktitle}% Title of current book

% Define verse counters
\newcounter{versea}
\newcounter{verseb}

\begin{document}

% Book and chapter commands
	\NewDocumentCommand{\chapterStart}{o O{Chap}}{% Command at the start of chapter
		\setcounter{versea}{0}%
		\setcounter{verseb}{0}%
		\stepcounter{chapter}%
		\IfNoValueF{#1}{%
			\begin{center}%
			\textbf{#2. \arabic{chapter}} \\
			{#1}\end{center}%
		}%
	}

	\NewDocumentCommand{\bookStart}{m o}{% Command at the start of book
		% arg 1 (mandatory): English title
		% arg 2 (optional):  Original title
	  \IfValueTF{#2}{%
	  	\book*{#1 \emph{(#2)}}%
			\def\booktitle{#1 \emph{(#2)}}%
		}{%
			\book*{#1}%
			\def\booktitle{#1}%
		}%
		\addcontentsline{toc}{book}{\booktitle}
		\setcounter{chapter}{0}% Set chapter count to zero.
		\chapterStart{}%
	}

% Verse format commands
	\NewDocumentCommand{\bvg}{o}{% Begin verse group
		\begin{ledgroup}%
		\beginnumbering%
		\setcounter{footnoteB}{0}%
	}

	\NewDocumentCommand{\bva}{o}{% Begin verse a
		\begin{large}\begin{stanza}% Begin stanza
		\IfNoValueTF{#1}{% Add verse number according to counter
			\stepcounter{versea}% Step verse counter
			\flagstanza{\textbf{\arabic{versea}}}%
		}{\IfEq{#1}{0}{}{% If optional verse number is NOT 0 we show it.
			\flagstanza{\textbf{#1}}%
		}}%
	}
	\NewDocumentCommand{\eva}{o}{% End verse a
		\& \end{stanza}\end{large}% End reledmac stanza
		\vspace{1.5mm}% Vertical space
	}

	\NewDocumentCommand{\bvb}{o}{% Begin verse b (see above)
		\IfNoValueTF{#1}{%
			\stepcounter{verseb}%
%			\textbf{\arabic{verseb} }%
		}{\IfEq{#1}{0}{}{%
%			\textbf{\textbf{#1}}
		}}%
		\noindent%
	}
	\NewDocumentCommand{\evb}{o}{% End verse b
		% Nothing (for now?)
	}

	\NewDocumentCommand{\evg}{o}{% End verse group
		\endnumbering\end{ledgroup}% End numbering and ledgroup
		\vspace{1cm}%
	}

% Note formatting
	% Sidenote margin
	\setlength{\ledlsnotesep}{2 \ledlsnotesep}

	% Make A footnotes paragraphs
	\Xarrangement[A]{paragraph}

	% Make B footnotes roman
	\renewcommand*{\thefootnoteB}{\alph{footnoteB}}

% Poem formatting
	% First line number at 3
	\firstlinenum{2}
	\linenumincrement{2}

	% Stanza indentation (required by reledmac)
	\setstanzaindents{5, 2, 2}
	\setcounter{stanzaindentsrepetition}{2}

	% Line numbers directly under verse number (kind of a hack)
	\setlength{\linenumsep}{-1.62pc}

	% Mark cæsura.
	\newcommand{\hld}{ · }%

	% Indent lines (in Ljóðaháttr or Galdralag).
	\newcommand{\ind}{%
		\hspace{1.5em}%
	}

	% Mark alliteration. This might not be present in the final version.
	\NewDocumentCommand{\alst}{m}{%
		\underline{#1}%
	}

	% Mark kennings.
	\NewDocumentCommand{\ken}{sm}{%
		% No small caps; text inside the brackets.
		\IfBooleanTF{#1}{% No small caps
			{[{#2}]}% EXAMPLE: [= Wooden]
		}{%
			\textsc{[{#2}]}% EXAMPLE: [ETTIN]
		}%
	}%

	% Mark names with angular brackets.
	\NewDocumentCommand{\name}{m}{%
	% Text inside the brackets.
		<{#1}>% EXAMPLE: <ettin>
	}%

% Index commands
	\NewDocumentCommand{\inx}{o m O{#2}}{% Index link (type, link, optional alt display)
		\IfNoValueTF{#1}{% TODO: phase this out
			ERRORERRORERROR%
		}{% Proper noun
			\hyperref[#1:#2]{#3\textsuperscript{#1}}%
		}%
	}

	\NewDocumentCommand{\inxitem}{o m}{% Index label (type, word)
		\item[\textbf{#2}]%
		\phantomsection\label{#1:#2}%
	}

% Sigla
	% Meters
	\newcommand{\Fornyrdislag}{% Law of ancient speeches
		\emph{Fornwordslaw}%
	}
	\newcommand{\Ljodahattr}{% Leed-meter
		\emph{Leed-meter}%
	}

	%Modern books and editions (TODO: move these to bibliography)
	\newcommand{\CV}{% Cleasby-Vigfússon dictionary of Old Norse
		\textciteshorttitle{CleasbyVigfusson}%\emph{C-V}%
	}
	\newcommand{\ONP}{% Dictionary of Old Norse Prose
		\emph{ONP}%
	}
	\newcommand{\Skp}{% Skaldic Poetry of the Scandinavian Middle Ages
		\emph{Skp}%
	}

	% Manuscripts
	\newcommand{\Regius}{% Codex Regius (of the poetic edda)
		\textbf{R}%
	}
	\newcommand{\AM}{% AM 748 I a 4to
		\textbf{A}%
	}
	\newcommand{\FlatMS}{% Flateyjarbok
		\textbf{F}%
	}
	\newcommand{\Hauksbok}{% Hauksbok
		\textbf{H}%
	}
	\newcommand{\GylfMS}{% For referring to Gylfaginning manuscripts when verses are attested there.
		\textbf{G}%
	}
	\newcommand{\RegiusProse}{% Codex Regius of the Prose Edda
		\textbf{S}%
	}
	\newcommand{\Trajectinus}{% Codex Trajectinus
		\textbf{T}%
	}
	\newcommand{\Wormianus}{% Codex Wormianus
		\textbf{W}%
	}
	\newcommand{\Upsaliensis}{% Codex Upsaliensis
		\textbf{U}%
	}
	\newcommand{\HildMS}{% For referring to the Hildebrandslied manuscript.
		\emph{Hild ms.}%
	}

	% Old texts
	% The command codes must be as close to the original language titles as possible.
	\newcommand{\Allvismal}{% Speeches of Allwise
		\emph{Allwise}%
	}
	\newcommand{\Baldrsdraumar}{% The Dreams of Balder
		\emph{Dreams}%
	}
	\newcommand{\Beowulf}{% Beewolf
		\emph{Beewolf}%
	}
	\newcommand{\Deor}{% Dear
		\emph{Dear}%
	}
	\newcommand{\Gulatingslog}{% Law of the Gole-thing
		\emph{GolL}%
	}
	\newcommand{\FGT}{% First Grammatical Treatise
		\emph{1GT}%
	}
	\newcommand{\FostrbroedhraSaga}{% Saw of the Foster-brothers
		\emph{FbrS}%
	}
	\newcommand{\FraLoka}{% From Lock
		\emph{FrL}%
	}
	\newcommand{\Grimnismal}{% Speeches oF Grimner
		\emph{Grimner}%
	}
	\newcommand{\Gylfaginning}{% The Guiling of Yilfer; for referring to Gylfaginning as a text
		\emph{Yilfer}%
	}
	\newcommand{\Haleygjatal}{% Tally of the Hallowlendings
		\emph{HalT}%
	}
	\newcommand{\Harbardsljod}{% Leed of Hoarbeard
		\emph{Hoarbeard}%
	}
	\newcommand{\Haustlong}{% Harvest-long
		\emph{Harvest-long}% TODO: add to bibliography
	}
	\newcommand{\Havamal}{% Speeches of the High One
		\emph{High}%
	}
	\newcommand{\HelgakvidaHjorvardssonar}{% Lay of Hallow Harwardson
		\emph{HHarw}%
	}
	\newcommand{\HelgakvidaTwo}{% Second Lay of Hallow Hundingsbane
		\emph{HHund II}%
	}
	\newcommand{\HervararSaga}{% Saw of Harware
		\emph{HarS}%
	}
	\newcommand{\Hildebrandslied}{% Speeches of Hildbrand
		\emph{Hildbrand}%
	}
	\newcommand{\Hymiskvida}{% Lay of Hymer
		\emph{Hymer}%
	}
	\newcommand{\Hyndluljod}{% Leed of Hindle
		\emph{Hindle}%
	}
	\newcommand{\Lokasenna}{% Flyting of Lock
		\emph{Lock}%
	}
	\newcommand{\Oddrunargratr}{% Weeping of Ordrun
		\emph{Ordrun}%
	}
	\newcommand{\Rigsthula}{% Thule of Righ
		\emph{Righ}%
	}
	\newcommand{\Sigrdrifumal}{% Speeches of Sighdrive
		\emph{Sighdrive}%
	}
	\newcommand{\Skaldskaparmal}{% The Matter of Scoldship
		\emph{Scold}%
	}
	\newcommand{\Skirnismal}{% Speeches of Shirner
		\emph{Shirner}%
	}
	\newcommand{\ThidreksSaga}{% Saw of Thedrich
		\emph{ThedS}%
	}
	\newcommand{\Thrymskvida}{% Lay of Thrim
		\emph{Thrim}%
	}
	\newcommand{\Vafthrudnismal}{% Speeches of Webthrithner
		\emph{Webthrithner}%
	}
	\newcommand{\VolsungaSaga}{% Saw of the Walsings
		\emph{WalsS}%
	}
	\newcommand{\Volundarkvida}{% Lay of Wayland
		\emph{Wayland}%
	}
	\newcommand{\Voluspa}{% Spae of the Wallow
		\emph{WSpae}%
	}
	\newcommand{\Waldere}{% Walder
		\emph{Walder}%
	}
	\newcommand{\YnglingaSaga}{% Saw of the Inglings
		\emph{IngS}%
	}
	\newcommand{\Ynglingatal}{% Tally of the Inglings
		\emph{IngT}%
	}

% Books

% Introduction, bibliography and abbreviations
	\frontmatter%
	\include{intro.tex}%

% Theology, mythology, generally independent order
	\mainmatter%
	\include{books/Spae of the Wallow.tex}% Weden, all gods
	\include{books/Speeches of Webthrithner.tex}% Weden
	\include{books/Dreams of Balder}% Weden
	\include{books/Speeches of the High One.tex}% Weden
	\include{books/Speeches of Grimner.tex}% Weden
	\include{books/Leed of Hoarbeard.tex}% Weden, Thunder
	\include{books/Lay of Thrim.tex}% Thunder
	\include{books/Lay of Hymer.tex}% Thunder, Tue
	\include{books/Flyting of Lock.tex}% Lock, all gods
%	\include{books/Speeches of Allwise.tex}% Thunder, Wisdom poem
  \include{books/Speeches of Shirner.tex}% Free, Gird
	\include{books/Thule of Righ.tex}% Righ
	\include{books/Leed of Hindle.tex}% Frow
	\include{books/Book of Spells.tex}% Assorted spells
	\include{books/Eddic fragments.tex}% Eddic fragments

% Heroic poems, in order of the Codex Regius'
	\include{books/Lay of Wayland.tex}%
	\include{books/First Lay of Hallow Hundingsbane.tex}%
	\include{books/Lay of Hallow Harwardson.tex}
	\include{books/Second Lay of Hallow Hundingsbane.tex}%
%	\include{books/Spae of Griper.tex}%
%	\include{books/Speeches of Reyn.tex}%
	\include{books/Speeches of Fathomer.tex}%
	\include{books/Speeches of Sighdrive.tex}%

% TODO: Summarize contents of "Great Lacuna" with excerpts from relevant Saws

%	\include{books/Fragmented Lay of Siward.tex}%
%	\include{books/From the Death of Siward.tex}%
%	\include{books/First Lay of Guthrun.tex}%
%	\include{books/Short Lay of Siward.tex}%
%	\include{books/Hell-ride of Byrnhild.tex}%
%	\include{books/Slaying of the Niflings.tex}%
%	\include{books/Second Lay of Guthrun.tex}%
	\include{books/Third Lay of Guthrun.tex}%
%	\include{books/Weeping of Ordrun.tex}%
	\include{books/Lay of Attle.tex}%
%	\include{books/Greenlendish Speeches of Attle.tex}%
%	\include{books/Instigation of Guthrun.tex}%
%	\include{books/Speeches of Hamthew.tex}%

% Additional heroic poems
	\include{books/Lay of Hildbrand.tex}%
%	\include{books/Fight at Finnsbury.tex}
%	\include{books/Beewolf.tex}% Probably not happening.

% Giga-index at the end
	\include{index.tex}%

\end{document}
