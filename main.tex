% This file should be compiled with XeLaTeX.

\documentclass[b5paper]{memoir}

% Font and typesetting
\usepackage[final]{microtype}

\usepackage{fontspec}
\setmainfont{Junicode}[
	Extension=.ttf,
	BoldFont=*-Bold,
	ItalicFont=*-Italic,
	BoldItalicFont=*-BoldItalic]
\newfontfamily{\greekfont}{Times New Roman}
\usepackage{polyglossia}
\setdefaultlanguage{english}

% TODO: Underline that does not skip descender?
% Should be called \nsunderline

% Bibliography
\usepackage[style=apa]{biblatex}
\addbibresource{bibliography.bib}
\DefineBibliographyStrings{english}{%
  sequens = {f\adddot},
  sequentes = {ff\adddot},
}

\newbibmacro*{textciteshorttitle}{% Cite short titles. From Stack Exchange: https://tex.stackexchange.com/questions/489928/biblatex-apa-textcite-with-shorttitle
  \ifbool{cbx:parens}
    {\bibcloseparen\global\boolfalse{cbx:parens}}
    {}%
  \setunit{\compcitedelim}%
  \printfield[bibhyperref]{shorttitle}%
  \iffieldundef{postnote}
    {}
    {\ifnumequal{\value{citecount}}{\value{citetotal}}
       {\printunit{\global\booltrue{cbx:parens}\addspace\bibopenparen}}
       {}}}

\DeclareCiteCommand{\textciteshorttitle}
  {\usebibmacro{cite:init}%
   \usebibmacro{prenote}}
  {\usebibmacro{citeindex}%
   \usebibmacro{textciteshorttitle}}
  {}
  {\usebibmacro{textcite:postnote}%
   \usebibmacro{cite:post}}

% Packages
\usepackage{xparse}% For better document commands
\usepackage{graphicx}% For rotating characters (used when citing runic inscriptions)
\usepackage{hyperref}% For index links
\usepackage{longtable}% Long tables.
\usepackage{tipa}% IPA

% Critical edition
\usepackage{reledmac}

% Headers
\pagestyle{myheadings}
\makeoddhead{myheadings}{\thepage}{book}{}
\makeevenhead{myheadings}{}{The Ancient Germanic Poetry}{\thepage}

% Define verse counters
\newcounter{versea}
\newcounter{verseb}
\newcounter{prosea}
\newcounter{proseb}

\begin{document}

% Book and chapter commands
  \setsecnumdepth{none}% Disable numbering of sections
  \maxsecnumdepth{none}% Disable numbering of sections

	\NewDocumentCommand{\chapterStart}{o O{Chap}}{% Command at the start of chapter
		\setcounter{versea}{0}%
		\setcounter{verseb}{0}%
		\stepcounter{section}%
		\IfNoValueF{#1}{%
			\begin{center}%
			\textbf{#2. \arabic{section}} \\
			{#1}\end{center}%
		}%
	}

	\NewDocumentCommand{\bookStart}{m o}{% Command at the start of book
		% arg 1 (mandatory): English title
		% arg 2 (optional):  Original title
	  \IfValueTF{#2}{%
      \chapter*{#1 \emph{(#2)}}%
      \def\booktitle{#1 \emph{(#2)}}%
    }{%
      \chapter*{#1}%
      \def\booktitle{#1}%
    }%
    \addcontentsline{toc}{chapter}{\booktitle}
    \setcounter{section}{0}% Set chapter count to zero.
    \chapterStart{}%
	}

% Verse format commands
	\NewDocumentCommand{\bvg}{o}{% Begin verse group
		\begin{ledgroup}%
		\beginnumbering%
		\setcounter{footnoteB}{0}%
	}

	\NewDocumentCommand{\bva}{o}{% Begin verse a
		\begin{large}\begin{stanza}% Begin stanza
		\IfNoValueTF{#1}{% Add verse number according to counter
			\stepcounter{versea}% Step verse counter
			\flagstanza{\textbf{\arabic{versea}}}%
		}{\IfEq{#1}{0}{}{% If optional verse number is NOT 0 we show it.
			\flagstanza{\textbf{#1}}%
		}}%
	}
	\NewDocumentCommand{\eva}{o}{% End verse a
		\& \end{stanza}\end{large}% End reledmac stanza
		\vspace{1.5mm}% Vertical space
	}

	\NewDocumentCommand{\bvb}{o}{% Begin verse b (see above)
		\IfNoValueTF{#1}{%
			\stepcounter{verseb}%
%			\textbf{\arabic{verseb} }%
		}{\IfEq{#1}{0}{}{%
%			\textbf{\textbf{#1}}
		}}%
		\noindent%
	}
	\NewDocumentCommand{\evb}{o}{% End verse b
		% Nothing (for now?)
	}

	\NewDocumentCommand{\evg}{o}{% End verse group
		\endnumbering\end{ledgroup}% End numbering and ledgroup
		\vspace{1cm}%
	}

% Prose format commands
	\NewDocumentCommand{\bpg}{o}{% Begin verse group
  	\begin{ledgroup}%
  	\beginnumbering%
  	\setcounter{footnoteB}{0}%
  }

  \NewDocumentCommand{\bpa}{o}{% Begin verse a
		\begin{large}% Begin stanza
		\IfNoValueTF{#1}{% Add verse number according to counter
			\stepcounter{prosea}% Step verse counter
			\flagstanza{\textbf{P\arabic{prosea}}}%
		}{\IfEq{#1}{0}{}{% If optional verse number is NOT 0 we show it.
			\flagstanza{\textbf{P#1}}%
		}}%
	}
	\NewDocumentCommand{\epa}{o}{% End verse a
		\& \end{large}% End large
		\vspace{1.5mm}% Vertical space
	}

	\NewDocumentCommand{\bpb}{o}{% Begin verse b (see above)
		\IfNoValueTF{#1}{%
			\stepcounter{proseb}%
%			\textbf{\arabic{verseb} }%
		}{\IfEq{#1}{0}{}{%
%			\textbf{\textbf{#1}}
		}}%
		\noindent%
	}
	\NewDocumentCommand{\epb}{o}{% End verse b
		% Nothing (for now?)
	}

	\NewDocumentCommand{\epg}{o}{% End verse group
		\endnumbering\end{ledgroup}% End numbering and ledgroup
		\vspace{1cm}%
	}

% Note formatting
	% Sidenote margin
	\setlength{\ledlsnotesep}{2 \ledlsnotesep}

	% Make A footnotes paragraphs
	\Xarrangement[A]{paragraph}

	% Make B footnotes roman
	\renewcommand*{\thefootnoteB}{\alph{footnoteB}}

% Poem formatting
	% First line number at 3
	\firstlinenum{2}
	\linenumincrement{2}

	% Stanza indentation (required by reledmac)
	\setstanzaindents{5, 2, 2}
	\setcounter{stanzaindentsrepetition}{2}

	% Line numbers directly under verse number (kind of a hack)
	\setlength{\linenumsep}{-1.62pc}

	% Mark cæsura.
	\newcommand{\hld}{ · }%

	% Indent lines (in Ljóðaháttr or Galdralag).
	\newcommand{\ind}{%
		\hspace{1.5em}%
	}

	% Mark alliteration. This might not be present in the final version.
	\NewDocumentCommand{\alst}{m}{%
		\underline{#1}%
	}

	% Mark kennings.
	\NewDocumentCommand{\ken}{sm}{%
		% No small caps; text inside the brackets.
		\IfBooleanTF{#1}{% No small caps
			{[{#2}]}% EXAMPLE: [= Wooden]
		}{%
			\textsc{[{#2}]}% EXAMPLE: [ETTIN]
		}%
	}%

	% Mark names with angular brackets.
	\NewDocumentCommand{\name}{m}{%
	% Text inside the brackets.
		<{#1}>% EXAMPLE: <ettin>
	}%

% Index commands
	\NewDocumentCommand{\inx}{o m O{#2}}{% Index link (type, link, optional alt display)
		\IfNoValueTF{#1}{% TODO: phase this out
			ERRORERRORERROR%
		}{% Proper noun
			\hyperref[#1:#2]{#3\textsuperscript{#1}}%
		}%
	}

	\NewDocumentCommand{\inxitem}{o m}{% Index label (type, word)
		\item[\textbf{#2}]%
		\phantomsection\label{#1:#2}%
	}

% Sigla
  \input{sigla.tex}%

% Render books
  \input{books.tex}%

\end{document}
